"use strict";(self.webpackChunk_aws_opa_on_aws_website=self.webpackChunk_aws_opa_on_aws_website||[]).push([[5616],{4673:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var o=t(4848),a=t(8453);const r={sidebar_position:1},i="AWS Control Tower and AFT",s={id:"integration/control-tower-and-aft",title:"AWS Control Tower and AFT",description:"Introduction",source:"@site/docs/integration/control-tower-and-aft.md",sourceDirName:"integration",slug:"/integration/control-tower-and-aft",permalink:"/docs/integration/control-tower-and-aft",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"Integration",permalink:"/docs/category/integration"},next:{title:"Git",permalink:"/docs/integration/git"}},c={},l=[{value:"Introduction",id:"introduction",level:3},{value:"Architecture",id:"architecture",level:2},{value:"Installing AWS Control Tower and AFT",id:"installing-aws-control-tower-and-aft",level:2},{value:"Integrating OPA on AWS to AFT",id:"integrating-opa-on-aws-to-aft",level:2},{value:"Introduction",id:"introduction-1",level:3},{value:"Step 1: Create OPA Management Account",id:"step-1-create-opa-management-account",level:3},{value:"Step 2: Deploy OPA",id:"step-2-deploy-opa",level:3},{value:"Step 3: Set up IAM Role for Application Account",id:"step-3-set-up-iam-role-for-application-account",level:3},{value:"Step 4: Create Application Account for OPA Integration",id:"step-4-create-application-account-for-opa-integration",level:3}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...n.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(e.header,{children:(0,o.jsx)(e.h1,{id:"aws-control-tower-and-aft",children:"AWS Control Tower and AFT"})}),"\n",(0,o.jsx)(e.h3,{id:"introduction",children:"Introduction"}),"\n",(0,o.jsxs)(e.p,{children:["This article will describe how to inegrate OPA on AWS with AWS Control Tower and AFT-",(0,o.jsx)(e.a,{href:"https://github.com/aws-ia/terraform-aws-control_tower_account_factory",children:"Account Factory for Terraform"}),"."]}),"\n",(0,o.jsx)(e.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsx)("p",{align:"center",children:(0,o.jsx)("img",{src:"/img/diagrams/aft-architecture.png"})}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"In the above architecture, we created a seprate OU to host IAC orchestration and an account for AFT to be deployed."}),"\n",(0,o.jsxs)(e.li,{children:["We can also use the same OU to host OPA on AWS Platform and it's platform artifacts - this is ",(0,o.jsx)(e.strong,{children:"not"})," for workload controlled accounts"]}),"\n"]}),"\n",(0,o.jsx)(e.h2,{id:"installing-aws-control-tower-and-aft",children:"Installing AWS Control Tower and AFT"}),"\n",(0,o.jsxs)(e.p,{children:["AWS Control Tower: ",(0,o.jsx)(e.strong,{children:"Must be deployed in your environment"}),"."]}),"\n",(0,o.jsx)(e.p,{children:"Account Factory for Terraform (AFT): Must be deployed and configured with your Control Tower environment."}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsxs)(e.li,{children:["For setting up Control Tower, follow this ",(0,o.jsx)(e.a,{href:"https://docs.aws.amazon.com/controltower/latest/userguide/setting-up.html",children:"link"}),"."]}),"\n",(0,o.jsxs)(e.li,{children:["For integrating AFT with your Control Tower environment, follow this ",(0,o.jsx)(e.a,{href:"https://developer.hashicorp.com/terraform/tutorials/aws/aws-control-tower-aft",children:"link"}),"."]}),"\n"]}),"\n",(0,o.jsx)(e.h2,{id:"integrating-opa-on-aws-to-aft",children:"Integrating OPA on AWS to AFT"}),"\n",(0,o.jsx)(e.h3,{id:"introduction-1",children:"Introduction"}),"\n",(0,o.jsx)(e.p,{children:'The AFT pipeline provide a process that create accounts by submitting a request to "account-requests" repository, as shown in the below diagram:'}),"\n",(0,o.jsx)("p",{align:"center",children:(0,o.jsx)("img",{src:"/img/diagrams/aft-pipeline.png"})}),"\n",(0,o.jsx)(e.p,{children:"The integration with OPA on AWS Platform is based on the principle of customization template - that creates a pre-baked role, that the platform / OPA pipeline can use to provision resources."}),"\n",(0,o.jsx)(e.h3,{id:"step-1-create-opa-management-account",children:"Step 1: Create OPA Management Account"}),"\n",(0,o.jsx)(e.p,{children:"This step is option. You can choose to deploy OPA in any existing account; however, we as a best practice we discourage doing so."}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsxs)(e.li,{children:["Create an AWS account within your Control Tower environment named ",(0,o.jsx)(e.code,{children:"OPA Management"}),". This account will host the OPA infrastructure."]}),"\n",(0,o.jsx)(e.li,{children:"AFT Repositories: AFT supports four repositories for account management and customizations:"}),"\n"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"account_request_repo_name: Manages new account requests."}),"\n",(0,o.jsx)(e.li,{children:"global_customizations_repo_name: Applies customizations across all AFT-created accounts."}),"\n",(0,o.jsx)(e.li,{children:"account_customizations_repo_name: Customizes specific accounts."}),"\n",(0,o.jsx)(e.li,{children:"account_provisioning_customizations_repo_name: Sets up custom non-Terraform integrations pre-account provisioning."}),"\n"]}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"Account Request:"}),"\n"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsxs)(e.li,{children:["Add an account request for the ",(0,o.jsx)(e.code,{children:"OPA Management"})," account in the account_request repository."]}),"\n"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-request\n\u2502   \u2514\u2500\u2500 terraform\n\u2502       \u251c\u2500\u2500 aft-providers.jinja\n\u2502       \u251c\u2500\u2500 backend.jinja\n\u2502       \u251c\u2500\u2500 modules\n\u2502       \u2502   \u2514\u2500\u2500 aft-account-request\n\u2502       \u2502       \u251c\u2500\u2500 ddb.tf\n\u2502       \u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u2514\u2500\u2500 opa_account-request.tf\n"})}),"\n",(0,o.jsx)(e.p,{children:"opa_account-request.tf ->"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-terraform",children:'module "opa_account_admin" {\n  source = "./modules/aft-account-request"\n  \n  control_tower_parameters = {\n    AccountEmail              = "<email>"\n    AccountName               = "OPA Management"\n    ManagedOrganizationalUnit = "<ou>"\n    SSOUserEmail              = "<user-email>"\n    SSOUserFirstName          = "<first-name>"\n    SSOUserLastName           = "<last-name>"\n  }\n  \n  account_tags = {\n    "Owner"       = "<owner>"\n    "Division"    = "<division>"\n    "Environment" = "<env>"\n    "CostCenter"  = "<cost-center>"\n    "BUCode"      = "<bu-code>"\n    "Project"     = "OPA"\n  }\n  \n  change_management_parameters = {\n    change_requested_by = "Organization AWS Control Tower Admin"\n    change_reason       = "Deploy OPA Management Account to host OPA infrastructure"\n  }\n  \n  custom_fields = {\n    note = "This account will be used to deploy OPA management portal infrastructure"\n  }\n}\n'})}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"Push these changes to trigger account creation with AFT. Wait for completion before proceeding to Step 2."}),"\n"]}),"\n",(0,o.jsx)(e.h3,{id:"step-2-deploy-opa",children:"Step 2: Deploy OPA"}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"Access: Ensure you have access to the OPA management account with the necessary permissions to deploy required infrastructure."}),"\n",(0,o.jsxs)(e.li,{children:["Installation: Follow OPA installation steps via this ",(0,o.jsx)(e.a,{href:"/docs/getting-started/deploy-the-platform",children:"link"}),"."]}),"\n"]}),"\n",(0,o.jsx)(e.h3,{id:"step-3-set-up-iam-role-for-application-account",children:"Step 3: Set up IAM Role for Application Account"}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsxs)(e.li,{children:["Automation with AFT: Use AFT for automating IAM role creation (",(0,o.jsx)(e.strong,{children:"OPAExecutionRole"}),") in the Application account, allowing OPA Management account to manage resources."]}),"\n",(0,o.jsx)(e.li,{children:"Customization Code:"}),"\n"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsxs)(e.li,{children:["Specify this as a template (",(0,o.jsx)(e.strong,{children:"OPA_INTEGRATION"}),") in the Account Customization AFT repository."]}),"\n"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-customizations\n\u2502   \u2514\u2500\u2500 OPA_INTEGRATION\n\u2502       \u251c\u2500\u2500 api_helpers\n\u2502       \u2502   \u251c\u2500\u2500 post-api-helpers.sh\n\u2502       \u2502   \u251c\u2500\u2500 pre-api-helpers.sh\n\u2502       \u2502   \u2514\u2500\u2500 python\n\u2502       \u2502       \u2514\u2500\u2500 requirements.txt\n\u2502       \u2514\u2500\u2500 terraform\n\u2502           \u251c\u2500\u2500 aft-providers.jinja\n\u2502           \u251c\u2500\u2500 backend.jinja\n\u2502           \u2514\u2500\u2500 main.tf\n"})}),"\n",(0,o.jsx)(e.p,{children:"main.tf ->"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-terraform",children:'data "aws_ssm_parameter" "opa_org_id" {\n  name = "/aft/account-request/custom-fields/opa-org-id"\n}\n\ndata "aws_ssm_parameter" "aft_management_account_id" {\n  name = "/aft/account-request/custom-fields/opa-account-id"\n}\n\ndata "aws_ssm_parameter" "opa_pipeline_role" {\n  name = "/aft/account-request/custom-fields/opa-pipeline-role"\n}\n\ndata "aws_ssm_parameter" "opa_platform_role" {\n  name = "/aft/account-request/custom-fields/opa-platform-role"\n}\n\ndata "aws_iam_policy_document" "assume_role_policy" {\n  statement {\n    effect  = "Allow"\n\n    principals {\n      type        = "AWS"\n      identifiers = [\n        data.aws_ssm_parameter.opa_platform_role.value,\n        data.aws_ssm_parameter.opa_pipeline_role.value\n      ]\n    }\n\n    actions = ["sts:AssumeRole"]\n\n  }\n}\n\nresource "aws_iam_role" "admin_role" {\n  name               = "OPAExecutionRole"\n  assume_role_policy = data.aws_iam_policy_document.assume_role_policy.json\n}\n\nresource "aws_iam_role_policy_attachment" "admin_attach" {\n  role       = aws_iam_role.admin_role.name\n  policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"\n}\n'})}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"Push Customization Code: Update the specified account customization repository with this code."}),"\n"]}),"\n",(0,o.jsx)(e.p,{children:(0,o.jsx)(e.img,{alt:"OPA Management Account Iam role flow with Application account",src:t(552).A+"",width:"1593",height:"513"})}),"\n",(0,o.jsx)(e.h3,{id:"step-4-create-application-account-for-opa-integration",children:"Step 4: Create Application Account for OPA Integration"}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"Account Request:"}),"\n"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"Create an Application account creation request tailored for OPA on AWS."}),"\n"]}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-tree",children:"\u251c\u2500\u2500 account-request\n\u2502   \u2514\u2500\u2500 terraform\n\u2502       \u251c\u2500\u2500 aft-providers.jinja\n\u2502       \u251c\u2500\u2500 backend.jinja\n\u2502       \u251c\u2500\u2500 modules\n\u2502       \u2502   \u2514\u2500\u2500 aft-account-request\n\u2502       \u2502       \u251c\u2500\u2500 ddb.tf\n\u2502       \u2502       \u251c\u2500\u2500 variables.tf\n\u2502       \u2502       \u2514\u2500\u2500 versions.tf\n\u2502       \u251c\u2500\u2500 opa_moderated_account1.tf\n\u2502       \u2514\u2500\u2500 opa_account-request.tf\n"})}),"\n",(0,o.jsx)(e.p,{children:"opa_moderated_account1.tf->"}),"\n",(0,o.jsx)(e.pre,{children:(0,o.jsx)(e.code,{className:"language-terraform",children:'module "opa_app_account_1" {\n  source = "./modules/aft-account-request"\n\n  control_tower_parameters = {\n    AccountEmail              = ""\n    AccountName               = "OPA Applicartion Account 1"\n    ManagedOrganizationalUnit = "Sandbox"\n    SSOUserEmail              = ""\n    SSOUserFirstName          = ""\n    SSOUserLastName           = ""\n  }\n\n  account_tags = {\n    "Owner"       = ""\n    "Division"    = ""\n    "Environment" = ""\n    "CostCenter"  = ""\n    "BUCode"      = ""\n    "Project"     = "OPA"\n  }\n\n  change_management_parameters = {\n    change_requested_by = "Organization AWS Control Tower Admin"\n    change_reason       = "Deploy OPA Application Account 1"\n  }\n\n  custom_fields = {\n    note = "This account will be used to deploy applications from OPA management portal"\n    opa-org-id = "OPA_ORG_ID"\n    opa-account-id = "OPA_ACCOUNT_ID"\n    opa-pipeline-role = "OPA_PIPELINE_IAM_ROLE"\n    opa-platform-role = "arn:aws:iam::OPA_ACCOUNT_ID:role/backstage-master-role"\n  }\n\n  account_customizations_name = "OPA_INTEGRATION"\n}\n'})}),"\n",(0,o.jsxs)(e.p,{children:[(0,o.jsx)(e.strong,{children:"Note"}),": We are using custom_fields here to inject variables that will be used by the Account Customization OPA_INTEGRATION template"]}),"\n",(0,o.jsx)(e.p,{children:"The actual values for these variable needs to be fetched from the OPA management account and Control Tower management account"}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"Login to the OPA Management account under the IAM service and Role. Copy the opa-pipeline-role and opa-platform-role"}),"\n",(0,o.jsx)(e.li,{children:"Login to the Control Tower management account. From the Control Tower service -> Organization tab, copy the OPA management account ID and the Organization ID that the  OPA management account is part of."}),"\n"]}),"\n",(0,o.jsxs)(e.ol,{children:["\n",(0,o.jsx)(e.li,{children:"Completion:"}),"\n"]}),"\n",(0,o.jsxs)(e.ul,{children:["\n",(0,o.jsx)(e.li,{children:"Push the request to the Account Request repo and wait for account creation to complete."}),"\n"]}),"\n",(0,o.jsxs)(e.p,{children:["Congratulations! You have successfully set up an Application account ready for OPA integration. For deploying applications using OPA, follow this ",(0,o.jsx)(e.a,{href:"/docs/getting-started/videos",children:"link"}),"."]})]})}function u(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,o.jsx)(e,{...n,children:(0,o.jsx)(d,{...n})}):d(n)}},552:(n,e,t)=>{t.d(e,{A:()=>o});const o=t.p+"assets/images/opa-iam-role-9d2f00ac7dd1332f78a94abdbce4c0c2.png"},8453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>s});var o=t(6540);const a={},r=o.createContext(a);function i(n){const e=o.useContext(r);return o.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function s(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),o.createElement(r.Provider,{value:e},n.children)}}}]);