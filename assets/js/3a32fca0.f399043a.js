"use strict";(self.webpackChunk_aws_opa_on_aws_website=self.webpackChunk_aws_opa_on_aws_website||[]).push([[133],{7218:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>r,metadata:()=>a,toc:()=>l});var i=t(5893),s=t(1151);const r={sidebar_position:5},o="Security",a={id:"techdocs/security",title:"Security",description:"Authentication with Backstage",source:"@site/docs/techdocs/security.md",sourceDirName:"techdocs",slug:"/techdocs/security",permalink:"/docs/techdocs/security",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5},sidebar:"tutorialSidebar",previous:{title:"Processes",permalink:"/docs/techdocs/process"},next:{title:"DIY",permalink:"/docs/category/diy"}},c={},l=[{value:"Authentication with Backstage",id:"authentication-with-backstage",level:2},{value:"Identity providers with Backstage",id:"identity-providers-with-backstage",level:3},{value:"Populating Backstage identity schema",id:"populating-backstage-identity-schema",level:3},{value:"Backstage permission model",id:"backstage-permission-model",level:2},{value:"Introduction",id:"introduction",level:3},{value:"Restricting access to templates",id:"restricting-access-to-templates",level:3},{value:"Restricting access to kinds",id:"restricting-access-to-kinds",level:3},{value:"AWS Security",id:"aws-security",level:2},{value:"Introduction",id:"introduction-1",level:3},{value:"Environments and access to AWS services",id:"environments-and-access-to-aws-services",level:3},{value:"Diving deep to access roles trust policy",id:"diving-deep-to-access-roles-trust-policy",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"security",children:"Security"}),"\n",(0,i.jsx)(n.h2,{id:"authentication-with-backstage",children:"Authentication with Backstage"}),"\n",(0,i.jsx)(n.p,{children:"OPA on AWS comes pre-configured to use OKTA as an Identity provider. While this demonstrates one type of identity provider, it can easily be changed to other common identity providers such as Active Directory or any other OAuth 2 supported provider."}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["There are multiple Identity Providers that are supported by Backstage. For the complete list, consult the ",(0,i.jsx)(n.a,{href:"https://backstage.io/docs/auth/",children:"Backstage reference"})]})}),"\n",(0,i.jsx)(n.h3,{id:"identity-providers-with-backstage",children:"Identity providers with Backstage"}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    idps["OKTA\n    Active Directory\n    Atlassian\n    Azure\n    Bitbucket\n    GitHub\n    Google IAP\n    Gitlab\n    OAuth 2 Custom Proxy"]\n    backstage["Backstage Platform"]\n    idps --\x3e backstage'}),"\n",(0,i.jsx)(n.p,{children:'The configurations to use an external IDP with Backstage require mapping to Backstage schemas - in particular the "Users" and "Groups" Schemas.\nBackstage offers two kinds:'}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'"kind": "Group"\n"kind": "User"\n'})}),"\n",(0,i.jsx)(n.p,{children:"The prescribed relationship between them can be expressed as (Okta example):"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'  {\n        "metadata": {\n            "namespace": "default",\n            "annotations": {\n                "backstage.io/managed-by-location": "okta-org:all",\n                "backstage.io/managed-by-origin-location": "okta-org:all"\n            },\n            "name": "some user name",\n            "title": "********@amazon.com",\n            "uid": "44e7bc31-4343-4145-ba7a-37796d7df965",\n            "etag": "15bd46919fe1befaea71cec3293584b82231e3db"\n        },\n        "kind": "User",\n        "apiVersion": "backstage.io/v1alpha1",\n        "spec": {\n            "profile": {\n                "email": ""********@@amazon.com"\n            },\n            "memberOf": []\n        },\n        "relations": [\n            {\n                "type": "memberOf",\n                "targetRef": "group:default/admins",\n                "target": {\n                    "kind": "group",\n                    "namespace": "default",\n                    "name": "admins"\n                }\n            },\n            {\n                "type": "memberOf",\n                "targetRef": "group:default/developers",\n                "target": {\n                    "kind": "group",\n                    "namespace": "default",\n                    "name": "developers"\n                }\n            },\n        ]\n    },\n'})}),"\n",(0,i.jsx)(n.p,{children:"OPA on AWS uses the Backstage schema (entity provider) to allow access, both on the Backstage platform and on AWS. Therefore, if you change the source which populates the Backstage identity schema, the behavior remains the same."}),"\n",(0,i.jsxs)(n.p,{children:["To configure LDAP with Backstage, consult the Backstage reference on ",(0,i.jsx)(n.a,{href:"https://backstage.io/docs/integrations/ldap/org/",children:"LDAP Organizational Data"})]}),"\n",(0,i.jsx)(n.h3,{id:"populating-backstage-identity-schema",children:"Populating Backstage identity schema"}),"\n",(0,i.jsxs)(n.p,{children:["OPA on AWS uses the ",(0,i.jsx)(n.a,{href:"https://www.npmjs.com/package/@roadiehq/catalog-backend-module-okta",children:(0,i.jsx)(n.strong,{children:"roadiehq catalog-backend-module-okta"})})," plugin to connect and update OKTA users and groups back to Backstage."]}),"\n",(0,i.jsx)(n.p,{children:"Here are some configuration options you may want to consider:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"userNamingStrategy (i.e: strip-domain-email)"}),"\n",(0,i.jsx)(n.li,{children:"groupNamingStrategy (i.e: kebab-case-name)"}),"\n",(0,i.jsx)(n.li,{children:"hierarchyConfig (i.e: key: 'profile.orgId', parentKey: 'profile.parentOrgId')"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://backstage.io/docs/auth/okta/provider",children:"Backstage Okta Provider Documentation"})}),"\n",(0,i.jsx)(n.h2,{id:"backstage-permission-model",children:"Backstage permission model"}),"\n",(0,i.jsx)(n.h3,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"TODO"}),"\n",(0,i.jsx)(n.h3,{id:"restricting-access-to-templates",children:"Restricting access to templates"}),"\n",(0,i.jsx)(n.p,{children:"TODO"}),"\n",(0,i.jsx)(n.h3,{id:"restricting-access-to-kinds",children:"Restricting access to kinds"}),"\n",(0,i.jsx)(n.p,{children:"TODO"}),"\n",(0,i.jsx)(n.h2,{id:"aws-security",children:"AWS Security"}),"\n",(0,i.jsx)(n.h3,{id:"introduction-1",children:"Introduction"}),"\n",(0,i.jsx)(n.p,{children:"While there are different methodologies when it comes to security in the cloud, we adopted some of the approaches we have seen at our financial customers. These include:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Segregation of access controls"}),"\n",(0,i.jsx)(n.li,{children:"Use of temporary credentials"}),"\n",(0,i.jsx)(n.li,{children:"Separation of duties and the least privileges principle"}),"\n",(0,i.jsx)(n.li,{children:"Use of different AWS accounts to ensure default restrictions"}),"\n",(0,i.jsx)(n.li,{children:"Separation of production/staging environments from development/sandbox environments"}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{type:"note",children:(0,i.jsxs)(n.p,{children:["The above principles are not a replacement for organization-level preventive and detective controls. It is recommended to use services like ",(0,i.jsx)(n.a,{href:"https://aws.amazon.com/controltower/",children:"AWS Control Tower"})," and ",(0,i.jsx)(n.a,{href:"https://docs.aws.amazon.com/organizations/latest/userguide/orgs_manage_policies_scps.html",children:"Service Control Policies (SCPs)"})," to have multiple layers of security from the developer platform throughout the organization governance and controls."]})}),"\n",(0,i.jsx)(n.h3,{id:"environments-and-access-to-aws-services",children:"Environments and access to AWS services"}),"\n",(0,i.jsx)(n.p,{children:'We define an environment as a "place" in AWS. Granting access to an environment will allow a user or process to gain access only to the resources of that environment, but not to other environments.'}),"\n",(0,i.jsx)(n.p,{children:"Definition of AWS Environment Provider:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Include all of the supporting software artifacts to run a particular type of workload (Container-based, Serverless, AI/ML etc..)."}),"\n",(0,i.jsx)(n.li,{children:"Must reside within an AWS Account and a region."}),"\n",(0,i.jsx)(n.li,{children:"Must provide at least two roles to gain access to the environment resources: a Provisioning role and an Operations role."}),"\n",(0,i.jsx)(n.li,{children:"Mutually exclusive by design - One provider cannot access resources from another provider, even if they are configured to use the same AWS account and region."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"There are several methods for a user to gain access to an environment:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Indirect access"})," - throughout the developer platform and pipeline, a developer can perform actions on an allowed target environment. The platform/pipeline will assume the target environment roles and get temporary credentials to perform the actions on behalf of the user."]}),"\n"]}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    user["User"]\n    platform["Platform"]\n    env((AWS Environment provider))\n    operations["Operations role"]\n    keys["Temporary credentials"]\n    user --\x3e platform --\x3e env --\x3e operations --\x3e keys --\x3e platform'}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    user["User"]\n    pipeline["Pipeline runner"]\n    env((AWS Environment provider))\n    provisioning["Provisioning role"]\n    keys["Temporary credentials"]\n    user --\x3e pipeline --\x3e env --\x3e provisioning --\x3e keys --\x3e pipeline'}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Direct access"})," - a user can assume credentials directly to the target environment access roles (Provisioning roles, operations role)"]}),"\n"]}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    user["User"]\n    env((AWS Environment provider))\n    provisioning["Provisioning/Operations role"]\n    keys["Temporary credentials"]\n    user --\x3e env --\x3e provisioning --\x3e keys --\x3e user'}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Resource specific access"})," - a user can assume access to a particular shared resource by the environment, such as: kubectl"]}),"\n"]}),"\n",(0,i.jsx)(n.mermaid,{value:'flowchart LR\n    user["User"]\n    env((AWS Environment provider))\n    kubectl["Kubectl service"]\n    keys["Temporary credentials"]\n    user --\x3e env --\x3e kubectl --\x3e keys --\x3e user'}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsx)(n.p,{children:"Environment provider authors can reason about the required set of permissions for provisioning and operating applications for this environment. OPA on AWS provides sample templates for AWS ECS, AWS EKS, and Serverless environment providers."})}),"\n",(0,i.jsx)(n.h3,{id:"diving-deep-to-access-roles-trust-policy",children:"Diving deep to access roles trust policy"}),"\n",(0,i.jsxs)(n.p,{children:["As described above, OPA on AWS provides a pattern of assuming access to particular AWS environments. Out of the box - When provisioning a new environment provider, the ",(0,i.jsx)(n.em,{children:"provisioning role"})," and ",(0,i.jsx)(n.em,{children:"operations role"})," are created and their trust policy is modified to enable the platform role and pipeline role respectively."]}),"\n",(0,i.jsxs)(n.p,{children:["example of: commercial-us-commercial-dev-",(0,i.jsx)(n.strong,{children:"provisioning-role"})," - Assumed by gitlab pipeline role"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "AWS": "arn:aws:iam::31**********:role/opa-platform-GitlabRunnerConstructGitlabRunnerIamR"\n            },\n            "Action": "sts:AssumeRole"\n        }\n    ]\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["example of: commercial-us-commercial-dev-",(0,i.jsx)(n.strong,{children:"operations-role"})," - Assumed by the platform role"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n    "Version": "2012-10-17",\n    "Statement": [\n        {\n            "Effect": "Allow",\n            "Principal": {\n                "AWS": "arn:aws:iam::31**********:role/backstage-master-role"\n            },\n            "Action": "sts:AssumeRole"\n        }\n    ]\n}\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["You can also configure these roles with federation to grant access to your users based on their membership in certain group that is set up for your identity provider. This can be done with SAML or WebIdentity - for more information, ",(0,i.jsx)(n.a,{href:"https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/",children:"read here"}),"."]})})]})}function p(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>o});var i=t(7294);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);